name: Production Deployment

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    environment: production
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up SSH Agent
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      - name: Trigger deployment script on VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
        run: |
          echo "[CI] Triggering remote deployment..."
          ssh $VPS_USER@$VPS_HOST "export BETTER_AUTH_SECRET=\"$BETTER_AUTH_SECRET\" && cd /var/www/openalbion/source/scripts && ./deploy.sh"
      - name: Smoke test
        run: curl -fsSL https://openalbion.org/api/health
      - name: Success
        if: success()
        run: |
          echo "[SUCCESS] Deployment completed successfully"
          echo "[STATUS] Active deployments:"
          echo "         - https://openalbion.org"
          echo "         - https://docs.openalbion.org"
      - name: Failure
        if: failure()
        run: |
          echo "[FAILURE] Remote deployment script reported an error"
          echo "[DEBUG] Review server-side deployment logs for more information" 